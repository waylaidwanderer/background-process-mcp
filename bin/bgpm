#!/usr/bin/env node
/* eslint-disable no-console */
import { spawnSync } from 'child_process';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const projectRoot = path.resolve(__dirname, '..');
const distPath = path.join(projectRoot, 'dist');
const cliPath = path.join(distPath, 'cli.js');

if (!fs.existsSync(distPath)) {
    console.log('--- Background Process Extension ---');
    console.log('First-time setup: compiling TypeScript...');

    const install = spawnSync('pnpm', ['install'], {
        cwd: projectRoot,
        stdio: 'inherit',
        shell: true,
    });

    if (install.error || install.status !== 0) {
        console.error('Error: Failed to install dependencies.');
        console.error('Please ensure pnpm is installed and try again.');
        process.exit(1);
    }

    const build = spawnSync('pnpm', ['build'], {
        cwd: projectRoot,
        stdio: 'inherit',
        shell: true,
    });

    if (build.error || build.status !== 0) {
        console.error('Error: Failed to build the project.');
        process.exit(1);
    }

    console.log('Build complete. Starting extension...');
    console.log('------------------------------------');
}

// After bootstrapping, spawn a new Node process to run the actual CLI.
// This ensures it starts with a clean state and can see the new node_modules.
const args = process.argv.slice(2);
const result = spawnSync('node', [cliPath, ...args], {
    cwd: projectRoot,
    stdio: 'inherit',
});

// Exit with the same code as the child process.
if (result.error) {
    console.error('Failed to start the CLI.', result.error);
    process.exit(1);
}
process.exit(result.status ?? 0);
